<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="vMq_BhQFUAROsOvsvEcUwXVw7sXr5_V56azfa2HOztc" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT, Danceiny, Spring Oscillator, Blog, Personal Websites, 计算机, IT, HUST, 华中科技大学, 武汉, Dian, 团队, 软件, 种子班, 人工智能, AI, Computer Vision, 计算机视觉, 广告" />





  <link rel="alternate" href="/atom.xml" title="弹簧振子的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />




  <meta property="fb:admins" content="danceiny" />
  <meta property="fb:app_id" content="366707543723815" />



<meta name="description" content="科技与人文的十字路口。">
<meta property="og:type" content="website">
<meta property="og:title" content="弹簧振子的博客">
<meta property="og:url" content="http://blog.cannot.cc/index.html">
<meta property="og:site_name" content="弹簧振子的博客">
<meta property="og:description" content="科技与人文的十字路口。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="弹簧振子的博客">
<meta name="twitter:description" content="科技与人文的十字路口。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":10,"offset_float":0,"b2t":true,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.cannot.cc/"/>





  <title>弹簧振子的博客 - Spring Oscillator</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '366707543723815',
      xfbml      : true,
      version    : 'v2.6'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/zh_Hans/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-98611430-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f5f17d67ca77cbb4017f4ff9dd7e3819";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=62043044";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    
      <div class="site-meta-headline">
        <a>
          <img class="custom-logo-image" src="http://opkk27k9n.bkt.clouddn.com/head.jpg"
               alt="弹簧振子的博客"/>
        </a>
      </div>
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">弹簧振子的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Spring Oscillator</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.cannot.cc/Celery_FAQ_4_1_Stable.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Danceiny">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opkk27k9n.bkt.clouddn.com/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="弹簧振子的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Celery_FAQ_4_1_Stable.html" itemprop="url">Celery常见问题</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-25T01:41:16+08:00">
                2017-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index">
                    <span itemprop="name">翻译</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Celery_FAQ_4_1_Stable.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="http://blog.cannot.cc/Celery_FAQ_4_1_Stable.html" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/Celery_FAQ_4_1_Stable.html" class="leancloud_visitors" data-flag-title="Celery常见问题">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  5,339
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  20
                </span>
              
            </div>
          

          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="译文出处"><a href="#译文出处" class="headerlink" title="译文出处"></a>译文出处</h2><p><a href="http://docs.celeryproject.org/en/latest/faq.html" target="_blank" rel="external">http://docs.celeryproject.org/en/latest/faq.html</a></p>
<p>This document describes the current stable version of Celery (4.1).</p>
<p>本文长期更新地址： <a href="http://blog.cannot.cc/Celery_FAQ_4_1_Stable.html">Celery4.1常见问题</a></p>
<p><strong>术语翻译对照</strong></p>
<table>
<thead>
<tr>
<th>英文</th>
<th>中文</th>
</tr>
</thead>
<tbody>
<tr>
<td>celery</td>
<td>celery</td>
</tr>
<tr>
<td>worker</td>
<td>worker</td>
</tr>
<tr>
<td>queue</td>
<td>队列</td>
</tr>
<tr>
<td>message</td>
<td>消息</td>
</tr>
<tr>
<td>task</td>
<td>任务</td>
</tr>
</tbody>
</table>
<h2 id="常规"><a href="#常规" class="headerlink" title="常规"></a>常规</h2><h3 id="应该用Celery来处理什么样的事情？"><a href="#应该用Celery来处理什么样的事情？" class="headerlink" title="应该用Celery来处理什么样的事情？"></a>应该用Celery来处理什么样的事情？</h3><p>答案：<a href="https://decafbad.com/blog/2008/07/04/queue-everything-and-delight-everyone/" target="_blank" rel="external">Queue everything and delight everyone</a> (<a href="">我的译文参见</a>)解释了为什么你会需要在web的上下文中使用队列。</p>
<p>这里是一些普遍的使用案例：</p>
<ul>
<li>在后台运行。例如For example, to finish the web request as soon as possible, then update the users page incrementally. This gives the user the impression of good performance and “snappiness”, even though the real work might actually take some time.</li>
<li>在web请求结束后运行</li>
<li>通过异步执行和重试，确保一些事情完成了</li>
<li>制定周期任务</li>
</ul>
<p>以及一定程度上：</p>
<ul>
<li>分布式计算</li>
<li>并行执行</li>
</ul>
<h2 id="误解"><a href="#误解" class="headerlink" title="误解"></a>误解</h2><h3 id="Celery真的有50000行代码吗？"><a href="#Celery真的有50000行代码吗？" class="headerlink" title="Celery真的有50000行代码吗？"></a>Celery真的有50000行代码吗？</h3><p>答案：没有。这个和类似的庞大数字在各种场合经常被报道。</p>
<ul>
<li>核心：7141行代码</li>
<li>测试：14209行</li>
<li>后端，贡献，兼容性代码：9032行</li>
</ul>
<p>代码行数不是有用的度量标准，因此，即便Celery真的有50K行代码，你也不能从这个数字中得到任何结论。</p>
<h3 id="Celery有很多依赖吗？"><a href="#Celery有很多依赖吗？" class="headerlink" title="Celery有很多依赖吗？"></a>Celery有很多依赖吗？</h3><p>一个普遍的批评是说Celery使用了太多的依赖。这种担忧背后的原理很难想象，特别是考虑到代码复用在现代软件开发中已经作为成熟的解决复杂性的方式，而且在使用诸如pip和PyPI包管理工具后引入依赖的开销非常低——安装和维护依赖的麻烦已经成为过去式了。</p>
<p>一路上，Celery替换了一些依赖，现在的依赖列表如下：</p>
<h4 id="celery"><a href="#celery" class="headerlink" title="celery"></a><strong>celery</strong></h4><ul>
<li><p>kombu<br>Kombu是Celery生态系统的一部分，是用来发送和接收messages的库。也是使得Celery支持如此多不同的message brokers的库。Kombu也被用在OpenStack项目中，和其他许多项目中，验证了将其从Celery基础代码中分割出来的选择是有效的。</p>
</li>
<li><p>billiard<br>billiard是Python多进程模块的一个分叉fork，包含了许多性能和稳定性改善。有一天这些改善最终将会被合并到Python中。</p>
</li>
</ul>
<p>billiard也被用来处理没有多进程模块的老版本python的兼容问题。</p>
<ul>
<li>pytz<br>提供时区定义和相关工具。<h4 id="kombu"><a href="#kombu" class="headerlink" title="kombu"></a>kombu</h4>Kombu依赖于下面的包：</li>
<li>amqp</li>
</ul>
<p>纯Python实现的amqp客户端。AMQP作为默认broker是很自然的依赖。</p>
<blockquote>
<blockquote>
<p>Note:<br>为了解决流行的配置选择的依赖，Celery定义了许多“bundle”包（捆绑安装^_^）。<a href="http://docs.celeryproject.org/en/latest/getting-started/introduction.html#bundles" target="_blank" rel="external">详见</a></p>
</blockquote>
</blockquote>
<h3 id="Celery是heavy-weight，很重的吗？"><a href="#Celery是heavy-weight，很重的吗？" class="headerlink" title="Celery是heavy-weight，很重的吗？"></a>Celery是heavy-weight，很重的吗？</h3><p>Celery在内存足迹（memory footprint）和性能上造成了非常轻微的开销。但是请注意，默认配置并未在时间或空间上进行优化，<a href="http://docs.celeryproject.org/en/latest/userguide/optimizing.html#guide-optimizing" target="_blank" rel="external">优化</a>。</p>
<h3 id="Celery依赖于pickle（序列化库）吗？"><a href="#Celery依赖于pickle（序列化库）吗？" class="headerlink" title="Celery依赖于pickle（序列化库）吗？"></a>Celery依赖于pickle（序列化库）吗？</h3><p>答案：不，Celery可以支持任何序列化策略。<br>我们內建支持JSON、YAML、Pickle和msgpack。每个任务都和一种content type挂钩，因此你甚至可以一个任务用pickle，另一个用JSON。默认的序列化支持是pickle，但是从4.0版本起，是JSON。如果你需要发送复杂的Python对象作为任务参数，你可以使用pickle作为序列化格式，但是需要注意<a href="http://docs.celeryproject.org/en/latest/userguide/security.html#security-serializers" target="_blank" rel="external">Notes in Serializers</a>。</p>
<p>如果你需要和其他语言通信，你应该使用合适于任务的序列化格式，通常意味着不能用pickle了。<br>你可以设置一个全局的默认序列化器serializer，默认的serializer用于特定的任务，或者发送单个任务 instance的时候决定用什么serializer。</p>
<h3 id="Celery只支持Django吗？"><a href="#Celery只支持Django吗？" class="headerlink" title="Celery只支持Django吗？"></a>Celery只支持Django吗？</h3><p>答案：不。</p>
<h3 id="我必须使用AMQP-RabbitMQ吗？"><a href="#我必须使用AMQP-RabbitMQ吗？" class="headerlink" title="我必须使用AMQP/RabbitMQ吗？"></a>我必须使用AMQP/RabbitMQ吗？</h3><p>答案：不，尽管使用RabbitMQ是推荐的，你也可以使用Redis，SQS，或者Qpid。更多参见<a href="http://docs.celeryproject.org/en/latest/getting-started/brokers/index.html#brokers" target="_blank" rel="external">broker</a></p>
<p>Redis作为broker表现不如AMQP，但是RabbitMQ作为broker，Redis作为结果存储的组合方式很常用。如果你有严格的可靠性要求，最好使用RabbitMQ，或者其他AMQP broker。一些transports也用轮询（polling），因此他们可能会消耗更多的资源。但是，如果你因为某些原因不能使用AMQP，可以放心使用这些替代品，在大部分场景下都能工作良好，而且以上不是为Celery量身定制的。如果你之前使用Redis/database作为队列也工作得很好，那现在也能。你一直可以到需要的时候再升级。</p>
<h3 id="Celery是多语言的吗？"><a href="#Celery是多语言的吗？" class="headerlink" title="Celery是多语言的吗？"></a>Celery是多语言的吗？</h3><p>答案：是。<br>worker是用Python实现的。如果某门语言有AMQP客户端，那用这门语言创建一个worker不需要做太多事情。一个Celery的worker只是一个连接broker来处理messages的程序。</p>
<p>而且，有另一种方式来做到语言独立，就是用REST的任务，这样你的任务就不是函数而是url了。有这个信息，你甚至可以创建一个简单的web服务器开启代码预加载。简单地暴露一个表现一个操作的端点endpoint，再创建一个任务，这个任务只是将一个HTTP请求表现给那个端点。</p>
<h2 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h2><h3 id="MySQL抛出死锁错误，怎么办？"><a href="#MySQL抛出死锁错误，怎么办？" class="headerlink" title="MySQL抛出死锁错误，怎么办？"></a>MySQL抛出死锁错误，怎么办？</h3><p>答案：MySQL有默认的隔离级别设置为REPEATABLE-READ（可重复读），如果你并不真正需要它，可以设置为READ-COMMITTED（读提交）。你可以通过在my.cnf中加入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line">transaction-isolation = READ-COMMMITTED</div></pre></td></tr></table></figure></p>
<p>更多有关InnoDB的事务模型，参见<a href="https://dev.mysql.com/doc/refman/5.1/en/innodb-transaction-model.html" target="_blank" rel="external">MySQL - The InnoDB Transaction Model and Locking </a>.</p>
<h3 id="worker什么都不做，hanging挂起了"><a href="#worker什么都不做，hanging挂起了" class="headerlink" title="worker什么都不做，hanging挂起了"></a>worker什么都不做，hanging挂起了</h3><p>答案：参见MySQL死锁，或者 Task.delay</p>
<h3 id="任务结果返回不可靠"><a href="#任务结果返回不可靠" class="headerlink" title="任务结果返回不可靠"></a>任务结果返回不可靠</h3><p>答案：如果你使用数据库后端存储结果，特别是MySQL，可能是死锁。参见上上个问题。</p>
<h3 id="为什么Task-delay-apply-这些调用之后worker只是挂起？"><a href="#为什么Task-delay-apply-这些调用之后worker只是挂起？" class="headerlink" title="为什么Task.delay/apply*这些调用之后worker只是挂起？"></a>为什么<code>Task.delay/apply*</code>这些调用之后worker只是挂起？</h3><p>答案： 一些AMQP客户端有一个bug，如果当前用户无法认证、密码不匹配或者用户没有访问指定虚拟主机的权限，就会挂起。检查broker的日志（RabbitMQ的在/var/log/rabbitmq/rabbit.log），通常会有消息描述原因。</p>
<h3 id="兼容FreeBSD系统吗？"><a href="#兼容FreeBSD系统吗？" class="headerlink" title="兼容FreeBSD系统吗？"></a>兼容FreeBSD系统吗？</h3><p>答案：看情况。<br>When using the RabbitMQ (AMQP) and Redis transports it should work out of the box.</p>
<p>For other transports the compatibility prefork pool is used and requires a working POSIX semaphore implementation, this is enabled in FreeBSD by default since FreeBSD 8.x. For older version of FreeBSD, you have to enable POSIX semaphores in the kernel and manually recompile billiard.</p>
<p>Luckily, Viktor Petersson has written a tutorial to get you started with Celery on FreeBSD here: <a href="http://www.playingwithwire.com/2009/10/how-to-get-celeryd-to-work-on-freebsd/" target="_blank" rel="external">http://www.playingwithwire.com/2009/10/how-to-get-celeryd-to-work-on-freebsd/</a></p>
<h3 id="遇到了完整性错误-IntegrityError-：Duplicate-Key-errors，什么原因？"><a href="#遇到了完整性错误-IntegrityError-：Duplicate-Key-errors，什么原因？" class="headerlink" title="遇到了完整性错误(IntegrityError)：Duplicate Key errors，什么原因？"></a>遇到了完整性错误(IntegrityError)：Duplicate Key errors，什么原因？</h3><p>答案：MySQL死锁。</p>
<h3 id="我的任务为什么没有被处理？"><a href="#我的任务为什么没有被处理？" class="headerlink" title="我的任务为什么没有被处理？"></a>我的任务为什么没有被处理？</h3><p>答案：用RabbitMQ的话，你可以通过运行如下命令看有多少个消费者当前在接收任务：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ rabbitmqctl list_queues -p &lt;myvhost&gt; name messages consumers</div><div class="line">Listing queues ...</div><div class="line">celery     2891    2</div></pre></td></tr></table></figure></p>
<p>以上输出表明任务-队列里有2891条messages在等待被处理，而且有两个消费者正在处理他们。</p>
<p>队列从未被清空的一个原因可能是你有一个过期的worker进程劫持了这些messages。如果这个worker没有被正确地杀掉，就有可能发生这种情况。</p>
<p>当一个message被一个worker接收到了，这个worker在标记该message被处理前会等待被应答。这个worker不会重发message给另一个消费者，直到该消费者被正确地关闭。<br>如果你遇到这个问题，你必须手动杀掉所有的worker并重启：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ pkill <span class="string">'celery worker'</span></div><div class="line"></div><div class="line">$ <span class="comment"># - If you don't have pkill use:</span></div><div class="line">$ <span class="comment"># ps auxww | grep 'celery worker' | awk '&#123;print $2&#125;' | xargs kill</span></div></pre></td></tr></table></figure></p>
<p>你可能必须等一会儿，知道所有的worker都结束了正在执行的任务。如果仍然长时间挂起，你可以强制杀掉：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ pkill -9 <span class="string">'celery worker'</span></div><div class="line"></div><div class="line">$ <span class="comment"># - If you don't have pkill use:</span></div><div class="line">$ <span class="comment"># ps auxww | grep 'celery worker' | awk '&#123;print $2&#125;' | xargs kill -9</span></div></pre></td></tr></table></figure></p>
<h3 id="我的任务为什么不会运行？"><a href="#我的任务为什么不会运行？" class="headerlink" title="我的任务为什么不会运行？"></a>我的任务为什么不会运行？</h3><p>答案：可能有语法错误导致任务模块没有被导入。<br>你可以看看通过手动执行任务，Celery能不能运行该任务：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;</span>&gt; from myapp.tasks import MyPeriodicTask</div><div class="line"><span class="meta">&gt;&gt;</span>&gt; MyPeriodicTask.delay()</div></pre></td></tr></table></figure></p>
<p>观察worker的日志文件，是否可以找到该任务，或者有没有其他错误发生。</p>
<h3 id="我的定时任务为什么不会运行？"><a href="#我的定时任务为什么不会运行？" class="headerlink" title="我的定时任务为什么不会运行？"></a>我的定时任务为什么不会运行？</h3><p>答案：参见上一个问题。</p>
<h3 id="我怎么清理所有的等待中任务？"><a href="#我怎么清理所有的等待中任务？" class="headerlink" title="我怎么清理所有的等待中任务？"></a>我怎么清理所有的等待中任务？</h3><p>答案：你可以使用<code>celery purge</code>命令来清理所有的已配置的任务队列。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ celery -A proj purge</div></pre></td></tr></table></figure></p>
<p>或者在代码中：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; from proj<span class="selector-class">.celery</span> import app</div><div class="line">&gt;&gt;&gt; app<span class="selector-class">.control</span><span class="selector-class">.purge</span>()</div><div class="line"><span class="number">1753</span></div></pre></td></tr></table></figure></p>
<p>如果你只是想清理特定队列中的消息，你必须使用AMQP API，或者<code>celery amqp</code>的功能：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ celery -A proj amqp queue.purge &lt;queue name&gt;</div></pre></td></tr></table></figure></p>
<p>1753是被清理的消息数。</p>
<p>你也可以开启<code>--purge</code>选项去启动worker，worker启动的时候就会清理消息。</p>
<h3 id="我清理了message，但是队列队列中仍然有消息残留？"><a href="#我清理了message，但是队列队列中仍然有消息残留？" class="headerlink" title="我清理了message，但是队列队列中仍然有消息残留？"></a>我清理了message，但是队列队列中仍然有消息残留？</h3><p>答案：只要任务真的被执行了，任务就被应答（从队列中移除）了。在worker接收到一个任务之后，在真正被执行前需要一点时间，特别是如果有大量任务已经在等待执行。没有被应答的消息，会被worker保持，直到消息关闭和broker（AMQP服务器）的连接。当连接关闭时（比如，因为worker停止了），任务会被broker重发给下一个可用的worker（或者在worker重启后又发给它），因此正确地清理等待任务的队列需要停掉所有的worker，然后再用<code>celery.control.purge</code>清理任务。</p>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><h3 id="如果我有一个id指向一个任务，怎么得到任务结果？"><a href="#如果我有一个id指向一个任务，怎么得到任务结果？" class="headerlink" title="如果我有一个id指向一个任务，怎么得到任务结果？"></a>如果我有一个id指向一个任务，怎么得到任务结果？</h3><p>答案：用<code>task.AsyncResult</code>。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;</span>&gt; result = my_task.AsyncResult(task_id)</div><div class="line"><span class="meta">&gt;&gt;</span>&gt; result.get()</div></pre></td></tr></table></figure></p>
<p>这会用任务的当前结果后端(result backend)返回一个<a href="http://docs.celeryproject.org/en/latest/reference/celery.result.html#celery.result.AsyncResult" target="_blank" rel="external">AsyncResult</a>的实例。<br>如果你需要指定一个自定义的结果后端，或者你想使用当前应用的默认后端，你可以使用<code>app.AsyncResult</code>:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;</span>&gt; result = app.AsyncResult(task_id)</div><div class="line"><span class="meta">&gt;&gt;</span>&gt; result.get()</div></pre></td></tr></table></figure></p>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><h3 id="使用pickle不是有安全隐患吗？"><a href="#使用pickle不是有安全隐患吗？" class="headerlink" title="使用pickle不是有安全隐患吗？"></a>使用pickle不是有安全隐患吗？</h3><p>答案：事实上，自从Celery4.0起，默认的序列化器是现在的JSON，就确保了人们有意识地选择序列化器并且意识到了这一担忧。<br>防范未认证授权的worker、数据库和其他传输pickled数据的服务接入是必要的。<br>注意到这不仅仅是你应该意识到有关Celery的问题，例如Django也使用pickle作为其缓存客户端。<br>对任务消息，你可以设置<code>task_serializer</code>为<code>json</code>或者<code>yaml</code>，而不是pickle。<br>类似地可以设置<code>result_serializer</code>。</p>
<h3 id="message是否可以加密？"><a href="#message是否可以加密？" class="headerlink" title="message是否可以加密？"></a>message是否可以加密？</h3><p>答案：一些AMQPworker支持使用SSL（包括RabbitMQ），你可以通过<code>broker_use_ssl</code>开启这一功能。<br>给消息加入额外的加密和安全性也是可能的，如果你有需求，应该联系邮件列表。</p>
<h3 id="以root用户运行worker是安全的吗？"><a href="#以root用户运行worker是安全的吗？" class="headerlink" title="以root用户运行worker是安全的吗？"></a>以root用户运行worker是安全的吗？</h3><p>答案：不是！<br>我们现在还没有发觉任何安全问题，但是认为安全问题不存在就太天真了，因此推荐以非特权用户运行Celery服务（celery woker， celery beat， celeryev等）。</p>
<h2 id="Brokers"><a href="#Brokers" class="headerlink" title="Brokers"></a>Brokers</h2><h3 id="为什么RabbitMQ崩溃了？"><a href="#为什么RabbitMQ崩溃了？" class="headerlink" title="为什么RabbitMQ崩溃了？"></a>为什么RabbitMQ崩溃了？</h3><p>答案：RabbitMQ如果用光内存就会崩溃。未来版本的RabbitMQ会修复这一个问题。<a href="https://www.rabbitmq.com/faq.html#node-runs-out-of-memory" target="_blank" rel="external">https://www.rabbitmq.com/faq.html#node-runs-out-of-memory</a></p>
<blockquote>
<blockquote>
<p>注意：<br>这已经不再是问题，RabbitMQ2.0+包含了一个新的固件，对内存不足错误是容忍的。因此推荐RabbitMQ2.1+版本配合Celery使用。如果你还在使用老版本，而且还遇到崩溃问题，赶紧升级吧。</p>
</blockquote>
</blockquote>
<p>Celery的错误配置最终也会导致老版本RabbitMQ的崩溃。即便不崩溃，也会消耗大量的资源，因此意识到这一普遍陷阱很重要。</p>
<ul>
<li><p>事件Events<br>加上<code>-E</code>选项运行worker将会在worker内部事件发生时发送消息。<br>事件应该只在你有一个活跃的监控器消费事件的时候才被开启，否则你需要定期清理事件队列。</p>
</li>
<li><p>AMQP 后端结果<br>在使用AMQP结果后端运行的时候，每个任务结果都会作为消息发送。如果你不收集collect这些结果，他们会积累，RabbitMQ最终会耗尽内存。<br>结果后端现在被弃用了，所以你不应该再使用。如果你需要多个消费者访问结果，可以用RPC后端来做rpc风格的调用，或者一个持久化的后端。<br>默认情况下结果在一天后失效。可以通过配置<code>result_expires</code>来降低这个有效期。</p>
</li>
</ul>
<p>如果你不需要任务结果，确保你设置了<code>ignore_result</code>选项。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.task(ignore_result=True)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mytask</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTask</span><span class="params">(Task)</span>:</span></div><div class="line">    ignore_result = <span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<h3 id="Celery可以和ActiveMQ-STOMP一起使用吗？"><a href="#Celery可以和ActiveMQ-STOMP一起使用吗？" class="headerlink" title="Celery可以和ActiveMQ/STOMP一起使用吗？"></a>Celery可以和ActiveMQ/STOMP一起使用吗？</h3><p>答案：不能。</p>
<h3 id="不使用AMQP-broker时，哪些特征不支持了？"><a href="#不使用AMQP-broker时，哪些特征不支持了？" class="headerlink" title="不使用AMQP broker时，哪些特征不支持了？"></a>不使用AMQP broker时，哪些特征不支持了？</h3><p>不完全列表：</p>
<ul>
<li>远程控制命令（仅由Redis支持）</li>
<li>事件监控在所有的虚拟传输中可能不会工作</li>
<li>header和fanout（扇出，Redis支持） exchange types</li>
</ul>
<h2 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h2><h3 id="调用tasks时如何复用连接？"><a href="#调用tasks时如何复用连接？" class="headerlink" title="调用tasks时如何复用连接？"></a>调用tasks时如何复用连接？</h3><p>答案：查看<code>broker_pool_limit</code>设置。v2.5+就默认开启连接池了。</p>
<h3 id="子进程中sudo反回了None"><a href="#子进程中sudo反回了None" class="headerlink" title="子进程中sudo反回了None"></a>子进程中sudo反回了None</h3><p>有一个sudo的配置选项来使得不经过tty运行sudo的处理是非法的。<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">Defaults requiretty</span></div></pre></td></tr></table></figure></p>
<p>如果你在<code>/etc/sudoers</code>文件中有这项配置，那worker作为守护进程跑的时候，任务将不能调用sudo。如果你想开启，你需要移除上面那一行。<a href="http://timelordz.com/wiki/Apache_Sudo_Commands" target="_blank" rel="external">http://timelordz.com/wiki/Apache_Sudo_Commands</a></p>
<h3 id="为什么workers不能处理任务的时候还能将任务从队列中删除？"><a href="#为什么workers不能处理任务的时候还能将任务从队列中删除？" class="headerlink" title="为什么workers不能处理任务的时候还能将任务从队列中删除？"></a>为什么workers不能处理任务的时候还能将任务从队列中删除？</h3><p>答案：worker拒绝未知任务、错误编码的消息、不包含正确域field的消息（按照任务消息协议）。<br>如果不拒绝这些，会导致重复传送，引发死循环。<br>最近版本的RabbitMQ有能力配置一个dead-letter队列来交换，所以那些被拒的消息就被转移到了那里。</p>
<h3 id="我可以通过任务名称调用任务吗？"><a href="#我可以通过任务名称调用任务吗？" class="headerlink" title="我可以通过任务名称调用任务吗？"></a>我可以通过任务名称调用任务吗？</h3><p>答案：是的，用<code>app.send_task</code>。<br>你也可以在任何语言中使用AMQP客户端通过名字调用一个任务：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;</span>&gt; app.send_task(<span class="string">'tasks.add'</span>, args=[<span class="number">2</span>, <span class="number">2</span>], kwargs=&#123;&#125;)</div><div class="line">&lt;<span class="symbol">AsyncResult:</span> <span class="number">373550</span>e8-b9a<span class="number">0</span>-<span class="number">4666</span>-bc61-ace01fa4f91d&gt;</div></pre></td></tr></table></figure></p>
<h3 id="我能设置当前任务的id吗？"><a href="#我能设置当前任务的id吗？" class="headerlink" title="我能设置当前任务的id吗？"></a>我能设置当前任务的id吗？</h3><p>答案：是的，当前id以及更多内容在任务请求里都是可用的。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.task(bind=True)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mytask</span><span class="params">(self)</span>:</span></div><div class="line">    cache.set(self.request.id, <span class="string">"Running"</span>)</div></pre></td></tr></table></figure></p>
<p><a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#task-request-info" target="_blank" rel="external">Task Request</a><br>如果你没有任务实例的引用，你可以使用<code>app.current_task</code>：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; app<span class="selector-class">.current_task</span><span class="selector-class">.request</span><span class="selector-class">.id</span></div></pre></td></tr></table></figure></p>
<p>但是需要注意，这可能是任何任务，一个被worker执行的任务，或者一个直接被任务调用的任务，或者一个急切eager调用的任务。（此处原文：But note that this will be any task, be it one executed by the worker, or a task called directly by that task, or a task called eagerly.）</p>
<p>可以用<code>current_worker_task</code>得到特定的当前被执行的任务：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; app<span class="selector-class">.current_worker_task</span><span class="selector-class">.request</span><span class="selector-class">.id</span></div></pre></td></tr></table></figure></p>
<p>需要注意<code>current_task</code>, 和 <code>current_worker_task</code> 可能是None。</p>
<h3 id="我如何指定一个自定义的task-id？"><a href="#我如何指定一个自定义的task-id？" class="headerlink" title="我如何指定一个自定义的task_id？"></a>我如何指定一个自定义的task_id？</h3><p>答案：能。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;</span>&gt; task.apply_async(args, kwargs, task_id=<span class="string">'…'</span>)</div></pre></td></tr></table></figure></p>
<h3 id="任务上可以使用装饰器吗？"><a href="#任务上可以使用装饰器吗？" class="headerlink" title="任务上可以使用装饰器吗？"></a>任务上可以使用装饰器吗？</h3><p>答案：能，但需要注意 <a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#task-basics" target="_blank" rel="external">Basics的侧边栏</a></p>
<h3 id="我能使用自然数作为task-ids吗？"><a href="#我能使用自然数作为task-ids吗？" class="headerlink" title="我能使用自然数作为task ids吗？"></a>我能使用自然数作为task ids吗？</h3><p>答案：能。但是确保其是唯一的，因为两个相同id的任务的行为是未定义的。</p>
<h3 id="我能指定，一旦另一个task结束，马上运行一个task吗？"><a href="#我能指定，一旦另一个task结束，马上运行一个task吗？" class="headerlink" title="我能指定，一旦另一个task结束，马上运行一个task吗？"></a>我能指定，一旦另一个task结束，马上运行一个task吗？</h3><p>答案：能。你可以在一个任务里面安全地启动一个任务。一个常用的模式是给任务加上回调：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> celery.utils.log <span class="keyword">import</span> get_task_logger</div><div class="line"></div><div class="line">logger = get_task_logger(__name__)</div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + y</div><div class="line"></div><div class="line"><span class="meta">@app.task(ignore_result=True)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_result</span><span class="params">(result)</span>:</span></div><div class="line">    logger.info(<span class="string">"log_result got: %r"</span>, result)</div></pre></td></tr></table></figure></p>
<p>调用：<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; <span class="comment">(add.s(2, 2)</span> | log_result.s<span class="comment">()</span>).delay<span class="comment">()</span></div></pre></td></tr></table></figure></p>
<p>获取更多信息：<a href="http://docs.celeryproject.org/en/latest/userguide/canvas.html" target="_blank" rel="external">Canvas: Designing Work-flows</a></p>
<h3 id="我能取消任务的执行吗？"><a href="#我能取消任务的执行吗？" class="headerlink" title="我能取消任务的执行吗？"></a>我能取消任务的执行吗？</h3><p>答案：能。用<code>result.revoke()</code>:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;</span>&gt; result = add.apply_async(args=[<span class="number">2</span>, <span class="number">2</span>], countdown=<span class="number">120</span>)</div><div class="line"><span class="meta">&gt;&gt;</span>&gt; result.revoke()</div></pre></td></tr></table></figure></p>
<p>或者，只有任务id时：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; from proj<span class="selector-class">.celery</span> import app</div><div class="line">&gt;&gt;&gt; app<span class="selector-class">.control</span><span class="selector-class">.revoke</span>(task_id)</div></pre></td></tr></table></figure></p>
<p>后者也支持传入任务id列表作为参数。</p>
<h3 id="为什么我的远程控制命令被所有的workers接收到了？"><a href="#为什么我的远程控制命令被所有的workers接收到了？" class="headerlink" title="为什么我的远程控制命令被所有的workers接收到了？"></a>为什么我的远程控制命令被所有的workers接收到了？</h3><p>答案：为了接收到广播的远程控制命令，每一个worker节点基于其节点名创建了一个唯一的队列名。如果你有超过一个worker的主机名相同，控制命令将会在他们间循环接收。<br>为解决这个问题，你可以用<code>-n</code>参数显式地为每个worker设置节点名：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> celery -A proj worker -n worker1@%h</span></div><div class="line"><span class="meta">$</span><span class="bash"> celery -A proj worker -n worker2@%h</span></div></pre></td></tr></table></figure></p>
<p>这里<code>%h</code>扩展成当前主机名。</p>
<h3 id="我能发送一些任务到限定的一些服务器上吗？"><a href="#我能发送一些任务到限定的一些服务器上吗？" class="headerlink" title="我能发送一些任务到限定的一些服务器上吗？"></a>我能发送一些任务到限定的一些服务器上吗？</h3><p>答案：是的。你可以使用不同的消息路由拓扑，将任务路由到一个或多个worker上，而且一个worker实例可以绑定到多个队列。<br><a href="http://docs.celeryproject.org/en/latest/userguide/routing.html" target="_blank" rel="external">Routing Tasks</a></p>
<h3 id="我能禁掉任务的预取prefetching吗？"><a href="#我能禁掉任务的预取prefetching吗？" class="headerlink" title="我能禁掉任务的预取prefetching吗？"></a>我能禁掉任务的预取prefetching吗？</h3><p>答案：可能！AMQP的属于prefetch令人疑惑，因为它只被用来描述任务预取限制(task prefetching limit)。没有涉及实际的预取。<br>禁掉预取限制是可能的，但是那意味着worker会消费尽可能快地消费尽可能多的任务。<br><a href="http://docs.celeryproject.org/en/latest/userguide/optimizing.html#optimizing-prefetch-limit" target="_blank" rel="external">一个有关预取限制的讨论，和worker的配置设定:同一时间只预定一个任务</a></p>
<h3 id="我可以在运行时改变周期任务的间隔时间吗？"><a href="#我可以在运行时改变周期任务的间隔时间吗？" class="headerlink" title="我可以在运行时改变周期任务的间隔时间吗？"></a>我可以在运行时改变周期任务的间隔时间吗？</h3><p>答案：可以。你可以使用Django的数据库调度器，或者你可以创建一个新的调度子类，覆写<code>is_due()</code>:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> celery.schedules <span class="keyword">import</span> schedule</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">my_schedule</span><span class="params">(schedule)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_due</span><span class="params">(self, last_run_at)</span>:</span></div><div class="line">        <span class="keyword">return</span> run_now, next_time_to_check</div></pre></td></tr></table></figure></p>
<h3 id="Celery支持task优先级吗？"><a href="#Celery支持task优先级吗？" class="headerlink" title="Celery支持task优先级吗？"></a>Celery支持task优先级吗？</h3><p>答案：是的， RabbitMQv3.5.0+就支持优先级，Redis传输仿真实现了优先级支持。<br>你也可以通过将高优先级任务路由到不同的worker中，从而把工作优先级排好。在真实世界中，这通常比每一个消息的优先级更为奏效。你可以使用速率限制（rate limiting）和单条消息优先级（per message priorities）的组合来实现响应式的系统。</p>
<h3 id="我应该使用重试retry还是acks-late？"><a href="#我应该使用重试retry还是acks-late？" class="headerlink" title="我应该使用重试retry还是acks_late？"></a>我应该使用重试retry还是acks_late？</h3><p>答案：看情况。用一个或者另一个都不是必要的，你可能想要使用两个。<br><code>Task.retry</code>用来重试任务，这是可以用<code>try</code>语句catch到可预知的错误（expected errors）的。AMQP事务不是用来处理这些错误的：如果任务引发了异常，仍然会被应答！</p>
<p>如果某些原因worker在执行中挂掉了，你需要任务再次执行时，可以使用<code>acks_late</code>设置。没人知道worker挂掉了，这很重要，如果知道worker挂掉，通常有不可恢复的错误，需要人工介入（worker或者任务代码的bug）。<br>理想情况下，你可以安全地重试任何失败的任务，但是有少数情况例外，假设有如下任务：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_upload</span><span class="params">(filename, tmpfile)</span>:</span></div><div class="line">    <span class="comment"># Increment a file count stored in a database</span></div><div class="line">    increment_file_counter()</div><div class="line">    add_file_metadata_to_db(filename, tmpfile)</div><div class="line">    copy_file_to_destination(filename, tmpfile)</div></pre></td></tr></table></figure></p>
<p>如果它在拷贝文件时挂掉了，我们会知道这里有个未完成状态存在。这不是个严格的教学场景，但你大概可以想象一些更为灾难性的场景。目前为止，编程较少的话则可靠性更弱。默认值是好的，需要它并且知道它们在干什么的用户仍然能开启<code>acks_late</code>（未来希望使用手动应答）。<br>此外，<code>Task.retry</code>在AMQP事务中有不可用的特性：在重试中延迟，最大重试次数等。<br>因此，可以对Python中的错误使用重试，如果你的任务是幂等的而且要求可靠性级别，结合<code>acks_late</code>一起使用。</p>
<h3 id="我可以计划让tasks在特定的时间执行吗？"><a href="#我可以计划让tasks在特定的时间执行吗？" class="headerlink" title="我可以计划让tasks在特定的时间执行吗？"></a>我可以计划让tasks在特定的时间执行吗？</h3><p>答案：可以。使用<code>Task.apply_async()</code>的eta参数。<a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html#guide-beat" target="_blank" rel="external">周期任务</a></p>
<h3 id="我可以安全地关闭worker吗？"><a href="#我可以安全地关闭worker吗？" class="headerlink" title="我可以安全地关闭worker吗？"></a>我可以安全地关闭worker吗？</h3><p>答案：是的，使用<code>TERM</code>信号。这会告诉worker去结束所有当前执行的作业，然后尽可能快地关闭。只要完全关闭，实验性的传输中也不应该会有任务丢失。<br>你决不应该通过<code>KILL</code>信号(<code>kill -9</code>)来停止worker，除非你试过几次<code>TERM</code>等了几分钟看有没有关闭。</p>
<p>另外，确保你只是杀掉了worker的主进程，而不是它的任何子进程。如果你知道关闭worker所依赖的一个子进程正在执行一个任务，你可以给这个特定的子进程指定一个杀死信号（kill signal），这也意味着任务会被设定一个WorkerLostError状态，因此这个任务不会再执行了。</p>
<p>如果你安装了<code>setproctitle</code>模块，指定进程类型很容易。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip install setproctitle</div></pre></td></tr></table></figure></p>
<p>安装这个库，你可以看到在ps命令的列表中看到进程类型，但是worker必须重启才能生效。</p>
<p><a href="http://docs.celeryproject.org/en/latest/userguide/workers.html#worker-stopping" target="_blank" rel="external">停止worker</a></p>
<h3 id="我可以在平台的后端运行worker吗？"><a href="#我可以在平台的后端运行worker吗？" class="headerlink" title="我可以在平台的后端运行worker吗？"></a>我可以在平台的后端运行worker吗？</h3><p>Answer: Yes, please see [Daemonization[(<a href="http://docs.celeryproject.org/en/latest/userguide/daemonizing.html#daemonizing" target="_blank" rel="external">http://docs.celeryproject.org/en/latest/userguide/daemonizing.html#daemonizing</a>.</p>
<h2 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h2><h3 id="django-celery-beat创建的数据库表有什么目的？"><a href="#django-celery-beat创建的数据库表有什么目的？" class="headerlink" title="django-celery-beat创建的数据库表有什么目的？"></a>django-celery-beat创建的数据库表有什么目的？</h3><p>用到数据库后端定时器（database-backend schedule）的时候，从PeriodicTask的数据模型中取出周期任务计划有一些其他的辅助表 (IntervalSchedule, CrontabSchedule, PeriodicTasks)。</p>
<h3 id="django-celery-results创建的数据库表有什么目的？"><a href="#django-celery-results创建的数据库表有什么目的？" class="headerlink" title="django-celery-results创建的数据库表有什么目的？"></a>django-celery-results创建的数据库表有什么目的？</h3><p>Django的数据库结果后端扩展需要两个额外的数据模型：TaskResult and GroupResult.</p>
<h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><h3 id="Celery支持Windows吗？"><a href="#Celery支持Windows吗？" class="headerlink" title="Celery支持Windows吗？"></a>Celery支持Windows吗？</h3><p>答案：不。4.x版本以上就不支持Windows了。</p>
<h1 id="欢迎扫码加群交流"><a href="#欢迎扫码加群交流" class="headerlink" title="欢迎扫码加群交流"></a>欢迎扫码加群交流</h1><p><img src="http://opkk27k9n.bkt.clouddn.com/17-11-26/19293813.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.cannot.cc/大鱼海棠影评.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Danceiny">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://opkk27k9n.bkt.clouddn.com/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="弹簧振子的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/大鱼海棠影评.html" itemprop="url">未命名</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-20T11:17:02+08:00">
                2017-10-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/大鱼海棠影评.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="http://blog.cannot.cc/大鱼海棠影评.html" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/大鱼海棠影评.html" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  570
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="鱼塘末日——-《大鱼海棠》"><a href="#鱼塘末日——-《大鱼海棠》" class="headerlink" title="鱼塘末日—— 《大鱼海棠》"></a>鱼塘末日—— 《大鱼海棠》</h1><p>标签（空格分隔）：影评 </p>
<hr>
<p>“美术的皮囊是要为故事整体做嫁衣的。”<br>很可惜《大鱼海棠》没有。</p>
<p>先说为什么选这部电影写影评。<br>我没有在12年前就听说过电影主创人员的梦想，我甚至在拿到电影票之前从未听说过这部电影。而电影票，也就是在一个无聊的下午，室友问我，手里有两张免费电影票，要不要一起去。<br>所以我一开始就不存在期望这东西。电影看得很开心。嗯，画面让我恍然想起宫崎骏，尤其是外景，还是颤抖的旁白音以及老奶奶，背景音乐也不错。电影放完还有那两位导演过来讲他们的故事。<br>导演说他是清华的工科生。哟，厉害厉害，我辈楷模。<br>导演说他做了十二年的梦。哟，厉害厉害，能睡这么久不简单呐。<br>故事呢？我记得导演说，打麻将那个场景，麻将的特写是要告诉女主三思而后行。<br>有趣。<br>过几天电影正式上映，网上一逛，骂声一片。<br>我想导演十二年的梦终于要醒了。<br>更加有趣了。</p>
<p>跟风骂几句。</p>
<ol>
<li>男主脱光竟然木有小鸡鸡？凭什么导演你有不让人家有？</li>
<li>女主真绿茶，人家为了您的幸福甘愿去死，没想到一直被当哥哥。</li>
<li>男主你说你除了故事一开始救了一条鱼，还干了啥？</li>
<li>女主应该以类似“反人类罪”的罪行被判罚吧？编剧的价值观呢？噢不对，编剧确定不是在划水？</li>
<li>庄子北冥有鱼的鱼，怎么那么小？说好的几千里呢？</li>
<li>那个老年旁白还能更无耻些吗？活了这么久怎么三观还是崩塌的？</li>
<li>中国风就是引出题名的“大鱼”，以及“鱼”的住所福建土楼？两千年的儒家思想呢？</li>
<li>三角恋玩得真不溜，比偶像剧差远了。</li>
<li>扯犊子情怀，国漫崛起新希望这名字好玩？</li>
<li>强行转3D，无耻圈钱。</li>
</ol>
<p>终于凑齐十大罪状。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://opkk27k9n.bkt.clouddn.com/head.jpg"
               alt="Danceiny" />
          <p class="site-author-name" itemprop="name">Danceiny</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/danceiny" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/iven5" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/danceiny" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-zhihu"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/danceiny1" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Danceiny</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("bOXRyG4NSvI7F1UQQEP2p7OJ-gzGzoHsz", "fD7LdtBtuvfbrFJ4ku6KIisl");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script>


  


  
  <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("bOXRyG4NSvI7F1UQQEP2p7OJ-gzGzoHsz", "fD7LdtBtuvfbrFJ4ku6KIisl");</script>
<script>
function showTime(Counter) {
	var query = new AV.Query(Counter);
	$(".leancloud_visitors").each(function() {
		var url = $(this).attr("id").trim();
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length == 0) {
					var content = '0 ' + $(document.getElementById(url)).text();
					$(document.getElementById(url)).text(content);
					return;
				}
				for (var i = 0; i < results.length; i++) {
					var object = results[i];
					var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
					$(document.getElementById(url)).text(content);
				}
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});

	});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else if ($('.post-title-link').length > 1) {
		showTime(Counter);
	}
}); 
</script>
  
</body>
</html>
